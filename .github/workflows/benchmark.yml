name: Benchmark

on:
  pull_request:

jobs:
  benchmark:
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 10
    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c # v1.7.1
        with:
          sdk: stable
      - uses: astral-sh/setup-uv@5a095e7a2014a4212f075830d4f7277575a9d098 # v7.3.1
        with:
          enable-cache: false

      # 1. Checkout Main and Benchmark
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: main
          path: main_ref
          fetch-depth: 1

      - name: Benchmark Main
        run: |
          # Copy PR's benchmark harness to main_ref to enable comparative measurement
          # This ensures we measure 'main' code with the 'new' benchmark logic (AOT mode, categories)
          cp benchmark/bench_compare.dart main_ref/benchmark/bench_compare.dart
          cp scripts/benchmark_runner.py main_ref/scripts/benchmark_runner.py

          cd main_ref
          dart pub get
          uv run scripts/benchmark_runner.py benchmark/bench_compare.dart --mode aot --save ../main_bench.json
        continue-on-error: true

      # 2. Benchmark Current PR (Root)
      - name: Benchmark PR
        run: |
          dart pub get
          uv run scripts/benchmark_runner.py benchmark/bench_compare.dart --mode aot --save pr_bench.json

      # 3. Compare Results
      - name: Compare Results
        run: |
          if [ -f "main_bench.json" ] && [ -f "pr_bench.json" ]; then
            uv run scripts/benchmark_runner.py --compare main_bench.json pr_bench.json --mode aot
          else
            echo "Skipping comparison (missing base/target json)"
            # Fallback: Just use summary
            cp benchmark_summary.md benchmark_comparison.md
          fi

      - run: cat benchmark_comparison.md >> $GITHUB_STEP_SUMMARY

      - name: Post to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            try {
              const file = fs.existsSync('benchmark_comparison.md') ? 'benchmark_comparison.md' : 'benchmark_summary.md';
              const report = fs.readFileSync(file, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            } catch (error) {
              console.log('No benchmark report found');
            }
